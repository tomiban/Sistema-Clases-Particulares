@model TeddyMVC.Models.AlumnoFacturacionViewModel

@{
    ViewBag.Title = "Facturación del Alumno";
}

<!-- CSS de DataTables y SweetAlert2 -->
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

@if (TempData["AlertMessage"] != null)
{
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        Swal.fire({
            title: '¡Éxito!',
            text: '@TempData["AlertMessage"]',
            icon: 'success',
            confirmButtonText: 'Aceptar'
        });
    });
</script>
}

<div class="container mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h2>Facturación del Alumno</h2>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h4>Datos Personales</h4>
                    <hr />
                    <dl class="row">
                        <dt class="col-sm-4">ID</dt>
                        <dd class="col-sm-8">@Model.Alumno.Id</dd>
                        <dt class="col-sm-4">DNI</dt>
                        <dd class="col-sm-8">@Model.Alumno.DNI</dd>
                        <dt class="col-sm-4">Domicilio</dt>
                        <dd class="col-sm-8">@Model.Alumno.Domicilio</dd>
                        <dt class="col-sm-4">Ciudad</dt>
                        <dd class="col-sm-8">@Model.Alumno.Ciudad</dd>
                        <dt class="col-sm-4">Telefono</dt>
                        <dd class="col-sm-8">@Model.Alumno.Telefono</dd>
                    </dl>
                </div>
                <div class="col-md-6">
                    <h4>Alumno</h4>
                    <hr />
                    <p class="lead">@Model.Alumno.Nombre @Model.Alumno.Apellido</p>
                </div>
            </div>

            <h3 class="mt-4">Turnos Pendientes de Pago</h3>
            <form id="facturacionForm">
                <table id="turnosTable" class="table table-hover table-striped">
                    <thead class="thead-dark">
                        <tr>
                            <th>Fecha</th>
                            <th>Horas</th>
                            <th>Precio por Hora</th>
                            <th>Total</th>
                            <th>Seleccionar</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.TurnosPendientes)
                        {
                            <tr>
                                <td>@item.Fecha.ToShortDateString()</td>
                                <td>@item.Horas</td>
                                <td>@item.PrecioHora.ToString("C")</td>
                                <td>@((item.Horas * item.PrecioHora).ToString("C"))</td>
                                <td>
                                    <input type="checkbox" name="turnosIds" value="@item.Id" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
                <button type="submit" formaction="@Url.Action("GenerarFacturaView", "Facturacion")"
                    class="btn btn-primary mt-3">Generar Factura</button>
                <button type="button" id="pagarButton" class="btn btn-success mt-3">Pagar Clases</button>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#turnosTable').DataTable({
                "language": {
                    url: "https://cdn.datatables.net/plug-ins/1.11.5/i18n/es-ES.json"
                }
            });

            $('#pagarButton').on('click', function () {
                var selectedTurnos = $('input[name="turnosIds"]:checked').map(function () {
                    return $(this).val();
                }).get();

                if (selectedTurnos.length === 0) {
                    Swal.fire({
                        title: 'Error',
                        text: 'No se han seleccionado turnos para pagar.',
                        icon: 'error',
                        confirmButtonText: 'Aceptar'
                    });
                    return;
                }

                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "Vas a pagar las clases seleccionadas.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Sí',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            type: 'POST',
                            url: '@Url.Action("PagarClases", "Alumnos")',
                            data: { turnosIds: selectedTurnos },
                            dataType: 'json',
                            success: function (response) {
                                Swal.fire({
                                    title: '¡Éxito!',
                                    text: response.message,
                                    icon: 'success',
                                    confirmButtonText: 'Aceptar'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        location.reload();
                                    }
                                });
                            },
                            error: function (xhr, status, error) {
                                Swal.fire({
                                    title: 'Error',
                                    text: 'Ocurrió un error al pagar las clases.',
                                    icon: 'error',
                                    confirmButtonText: 'Aceptar'
                                });
                            }
                        });
                    }
                });
            });
        });
    </script>

}
